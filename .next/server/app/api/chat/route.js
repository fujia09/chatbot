(()=>{var e={};e.id=276,e.ids=[276],e.modules={44237:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=44237,e.exports=t},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},14985:e=>{"use strict";e.exports=require("dns")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},81630:e=>{"use strict";e.exports=require("http")},73496:e=>{"use strict";e.exports=require("http2")},55591:e=>{"use strict";e.exports=require("https")},91645:e=>{"use strict";e.exports=require("net")},21820:e=>{"use strict";e.exports=require("os")},33873:e=>{"use strict";e.exports=require("path")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},34631:e=>{"use strict";e.exports=require("tls")},83997:e=>{"use strict";e.exports=require("tty")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},73566:e=>{"use strict";e.exports=require("worker_threads")},74075:e=>{"use strict";e.exports=require("zlib")},77598:e=>{"use strict";e.exports=require("node:crypto")},73024:e=>{"use strict";e.exports=require("node:fs")},57075:e=>{"use strict";e.exports=require("node:stream")},37830:e=>{"use strict";e.exports=require("node:stream/web")},41540:(e,t,r)=>{"use strict";let a;r.r(t),r.d(t,{patchFetch:()=>ej,routeModule:()=>ek,serverHooks:()=>eO,workAsyncStorage:()=>ew,workUnitAsyncStorage:()=>eP});var n={};r.r(n),r.d(n,{POST:()=>ev});var i=r(25986),s=r(68827),o=r(27034),l=r(23619),u=r(56550),c=r(95693),p=r(45109),m=r(63255),d=r(23383),f=r(21590),g=r(92898),h=r(71399),y=r(80455),_=r(27532),b=r(35551),v=r(68141),k=r(38521);function w(e,t){let r;if(void 0===e.function)return;if(t?.partial)try{r=(0,b.d1)(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new _.CC([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}let a={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(a.id=e.id),a}function P(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}class O extends v.T{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw Error("Not supported.")}async parse(){throw Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let r;let a=e[0].message;if((0,k.KX)(a)&&a.tool_calls?.length?r=a.tool_calls.map(e=>{let{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==a.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(a.additional_kwargs.tool_calls)).map(e=>w(e,{returnId:this.returnId,partial:t}))),!r)return[];let n=[];for(let e of r)if(void 0!==e){let t={type:e.name,args:e.args,id:e.id};n.push(t)}return n}}class j extends O{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new _.CC(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?r[0]:r:void 0}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?this._validateResult(r[0]):await Promise.all(r.map(e=>this._validateResult(e))):void 0}}var x=r(39936),A=r(80026),S=r(8199);function T(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function N(e,t,r,a,n){e[t]=r,T(e,t,a,n)}let I=(e,t)=>G(e.innerType._def,t),E=(e,t)=>{let r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(let a of e.checks)switch(a.kind){case"min":N(r,"minimum",a.value,a.message,t);break;case"max":N(r,"maximum",a.value,a.message,t)}return r},R=e=>(!("type"in e)||"string"!==e.type)&&"allOf"in e,M={cuid:/^[cC][^\s-]{8,}$/,cuid2:/^[0-9a-z]+$/,ulid:/^[0-9A-HJKMNP-TV-Z]{26}$/,email:/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,emoji:()=>(void 0===a&&(a=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),a),base64:/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,nanoid:/^[a-zA-Z0-9_-]{21}$/};function Z(e,t){let r={type:"string"};function a(e){return"escape"===t.patternStrategy?$(e):e}if(e.checks)for(let n of e.checks)switch(n.kind){case"min":N(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":N(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":q(r,"email",n.message,t);break;case"format:idn-email":q(r,"idn-email",n.message,t);break;case"pattern:zod":z(r,M.email,n.message,t)}break;case"url":q(r,"uri",n.message,t);break;case"uuid":q(r,"uuid",n.message,t);break;case"regex":z(r,n.regex,n.message,t);break;case"cuid":z(r,M.cuid,n.message,t);break;case"cuid2":z(r,M.cuid2,n.message,t);break;case"startsWith":z(r,RegExp(`^${a(n.value)}`),n.message,t);break;case"endsWith":z(r,RegExp(`${a(n.value)}$`),n.message,t);break;case"datetime":q(r,"date-time",n.message,t);break;case"date":q(r,"date",n.message,t);break;case"time":q(r,"time",n.message,t);break;case"duration":q(r,"duration",n.message,t);break;case"length":N(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t),N(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":z(r,RegExp(a(n.value)),n.message,t);break;case"ip":"v6"!==n.version&&q(r,"ipv4",n.message,t),"v4"!==n.version&&q(r,"ipv6",n.message,t);break;case"emoji":z(r,M.emoji,n.message,t);break;case"ulid":z(r,M.ulid,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":q(r,"binary",n.message,t);break;case"contentEncoding:base64":N(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":z(r,M.base64,n.message,t)}break;case"nanoid":z(r,M.nanoid,n.message,t)}return r}let $=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),q=(e,t,r,a)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):N(e,"format",t,r,a)},z=(e,t,r,a)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:L(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):N(e,"pattern",L(t,a),r,a)},L=(e,t)=>{let r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;let a={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},n=a.i?r.source.toLowerCase():r.source,i="",s=!1,o=!1,l=!1;for(let e=0;e<n.length;e++){if(s){i+=n[e],s=!1;continue}if(a.i){if(o){if(n[e].match(/[a-z]/)){l?(i+=n[e],i+=`${n[e-2]}-${n[e]}`.toUpperCase(),l=!1):"-"===n[e+1]&&n[e+2]?.match(/[a-z]/)?(i+=n[e],l=!0):i+=`${n[e]}${n[e].toUpperCase()}`;continue}}else if(n[e].match(/[a-z]/)){i+=`[${n[e]}${n[e].toUpperCase()}]`;continue}}if(a.m){if("^"===n[e]){i+=`(^|(?<=[\r
]))`;continue}if("$"===n[e]){i+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===n[e]){i+=o?`${n[e]}\r
`:`[${n[e]}\r
]`;continue}i+=n[e],"\\"===n[e]?s=!0:o&&"]"===n[e]?o=!1:o||"["!==n[e]||(o=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return i};function C(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===S.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:G(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};let r={type:"object",additionalProperties:G(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===S.kY.ZodString&&e.keyType._def.checks?.length){let a=Object.entries(Z(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:a}}return e.keyType?._def.typeName===S.kY.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}let U={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},K=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>G(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0},Y=(e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return G(e.innerType._def,t);let r=G(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:{}},r]}:{}},F=(e,t)=>{if("input"===t.pipeStrategy)return G(e.in._def,t);if("output"===t.pipeStrategy)return G(e.out._def,t);let r=G(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),a=G(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]});return{allOf:[r,a].filter(e=>void 0!==e)}},D=(e,t)=>G(e.innerType._def,t),B=Symbol("Let zodToJsonSchema decide on which parser to use"),J={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},W=e=>"string"==typeof e?{...J,basePath:["#"],definitions:{},name:e}:{...J,basePath:["#"],definitions:{},...e};function G(e,t,r=!1){let a=t.seen.get(e);if(t.override){let n=t.override?.(e,t,a,r);if(n!==B)return n}if(a&&!r){let e=V(a,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}let n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);let i=X(e,e.typeName,t,r);return i&&Q(e,t,i),n.jsonSchema=i,i}let V=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:H(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},H=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},X=(e,t,r,a)=>{switch(t){case S.kY.ZodString:return Z(e,r);case S.kY.ZodNumber:return function(e,t){let r={type:"number"};if(!e.checks)return r;for(let a of e.checks)switch(a.kind){case"int":r.type="integer",T(r,"type",a.message,t);break;case"min":"jsonSchema7"===t.target?a.inclusive?N(r,"minimum",a.value,a.message,t):N(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),N(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?N(r,"maximum",a.value,a.message,t):N(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),N(r,"maximum",a.value,a.message,t));break;case"multipleOf":N(r,"multipleOf",a.value,a.message,t)}return r}(e,r);case S.kY.ZodObject:return function(e,t){let r={type:"object",...Object.entries(e.shape()).reduce((e,[r,a])=>{if(void 0===a||void 0===a._def)return e;let n=G(a._def,{...t,currentPath:[...t.currentPath,"properties",r],propertyPath:[...t.currentPath,"properties",r]});return void 0===n?e:{properties:{...e.properties,[r]:n},required:a.isOptional()&&!t.openaiStrictMode?e.required:[...e.required,r]}},{properties:{},required:[]}),additionalProperties:"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:G(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:G(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0};return r.required.length||delete r.required,r}(e,r);case S.kY.ZodBigInt:return function(e,t){let r={type:"integer",format:"int64"};if(!e.checks)return r;for(let a of e.checks)switch(a.kind){case"min":"jsonSchema7"===t.target?a.inclusive?N(r,"minimum",a.value,a.message,t):N(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),N(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?N(r,"maximum",a.value,a.message,t):N(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),N(r,"maximum",a.value,a.message,t));break;case"multipleOf":N(r,"multipleOf",a.value,a.message,t)}return r}(e,r);case S.kY.ZodBoolean:return{type:"boolean"};case S.kY.ZodDate:return function e(t,r,a){let n=a??r.dateStrategy;if(Array.isArray(n))return{anyOf:n.map((a,n)=>e(t,r,a))};switch(n){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return E(t,r)}}(e,r);case S.kY.ZodUndefined:return{not:{}};case S.kY.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case S.kY.ZodArray:return function(e,t){let r={type:"array"};return e.type?._def?.typeName!==S.kY.ZodAny&&(r.items=G(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&N(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&N(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(N(r,"minItems",e.exactLength.value,e.exactLength.message,t),N(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case S.kY.ZodUnion:case S.kY.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return K(e,t);let r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every(e=>e._def.typeName in U&&(!e._def.checks||!e._def.checks.length))){let e=r.reduce((e,t)=>{let r=U[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(r.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=r.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===r.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:r.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(r.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:r.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return K(e,t)}(e,r);case S.kY.ZodIntersection:return function(e,t){let r=[G(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),G(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter(e=>!!e),a="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0,n=[];return r.forEach(e=>{if(R(e))n.push(...e.allOf),void 0===e.unevaluatedProperties&&(a=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else a=void 0;n.push(t)}}),n.length?{allOf:n,...a}:void 0}(e,r);case S.kY.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,r)=>G(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:G(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,r)=>G(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])}}(e,r);case S.kY.ZodRecord:return C(e,r);case S.kY.ZodLiteral:return function(e,t){let r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case S.kY.ZodEnum:return{type:"string",enum:[...e.values]};case S.kY.ZodNativeEnum:return function(e){let t=e.values,r=Object.keys(e.values).filter(e=>"number"!=typeof t[t[e]]).map(e=>t[e]),a=Array.from(new Set(r.map(e=>typeof e)));return{type:1===a.length?"string"===a[0]?"string":"number":["string","number"],enum:r}}(e);case S.kY.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target||"property"===t.nullableStrategy?{type:U[e.innerType._def.typeName],nullable:!0}:{type:[U[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){let r=G(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let r=G(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case S.kY.ZodOptional:return Y(e,r);case S.kY.ZodMap:return function(e,t){return"record"===t.mapStrategy?C(e,t):{type:"array",maxItems:125,items:{type:"array",items:[G(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},G(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,r);case S.kY.ZodSet:return function(e,t){let r={type:"array",uniqueItems:!0,items:G(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&N(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&N(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case S.kY.ZodLazy:return G(e.getter()._def,r);case S.kY.ZodPromise:return G(e.type._def,r);case S.kY.ZodNaN:case S.kY.ZodNever:return{not:{}};case S.kY.ZodEffects:return function(e,t,r){return"input"===t.effectStrategy?G(e.schema._def,t,r):{}}(e,r,a);case S.kY.ZodAny:case S.kY.ZodUnknown:return{};case S.kY.ZodDefault:return function(e,t){return{...G(e.innerType._def,t),default:e.defaultValue()}}(e,r);case S.kY.ZodBranded:return G(e.type._def,r);case S.kY.ZodReadonly:return D(e,r);case S.kY.ZodCatch:return I(e,r);case S.kY.ZodPipeline:return F(e,r);case S.kY.ZodFunction:case S.kY.ZodVoid:case S.kY.ZodSymbol:default:return}},Q=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),ee=e=>"_def"in e?e._def:e,et=e=>{let t=W(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[ee(r),{def:ee(r),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}},er=(e,t)=>{let r=et(t),a="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,n=G(e._def,void 0===a?r:{...r,currentPath:[...r.basePath,r.definitionPath,a]},!1)??{},i="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==i&&(n.title=i);let s=(()=>{if(function(e){if(!e)return!0;for(let t in e)return!1;return!0}(r.definitions))return;let e={},t=new Set;for(let a=0;a<500;a++){let a=Object.entries(r.definitions).filter(([e])=>!t.has(e));if(0===a.length)break;for(let[n,i]of a)e[n]=G(ee(i),{...r,currentPath:[...r.basePath,r.definitionPath,n]},!0)??{},t.add(n)}return e})(),o=void 0===a?s?{...n,[r.definitionPath]:s}:n:"duplicate-ref"===r.nameStrategy?{...n,...s||r.seenRefs.size?{[r.definitionPath]:{...s,...r.seenRefs.size?{[a]:n}:void 0}}:void 0}:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...s,[a]:n}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function ea(e,t){return er(e,{openaiStrictMode:!0,name:t.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}var en=r(28723),ei=r(88608);function es(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function eo(e){let t;return e.constructor.name===en.qA.name?(t=Error(e.message)).name="TimeoutError":e.constructor.name===en.cH.name?(t=Error(e.message)).name="AbortError":t=400===e.status&&e.message.includes("tool_calls")?es(e,"INVALID_TOOL_RESULTS"):401===e.status?es(e,"MODEL_AUTHENTICATION"):429===e.status?es(e,"MODEL_RATE_LIMIT"):404===e.status?es(e,"MODEL_NOT_FOUND"):e,t}function el(e,t){let r=[];for(let[a,n]of Object.entries(e.properties??{}))n.description&&t<2&&r.push(`// ${n.description}`),e.required?.includes(a)?r.push(`${a}: ${eu(n,t)},`):r.push(`${a}?: ${eu(n,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function eu(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>eu(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",el(e,t+2),"}"].join("\n");case"array":if(e.items)return`${eu(e.items,t)}[]`;return"any[]";default:return""}}function ec(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!p.cM.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}function ep(e,t){return e.flatMap(e=>{let r=ec(e);"system"===r&&ed(t)&&(r="developer");let a={role:r,content:e.content};return(null!=e.name&&(a.name=e.name),null!=e.additional_kwargs.function_call&&(a.function_call=e.additional_kwargs.function_call,a.content=null),(0,p.KX)(e)&&e.tool_calls?.length?(a.tool_calls=e.tool_calls.map(P),a.content=null):(null!=e.additional_kwargs.tool_calls&&(a.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(a.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio)?[a,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:a})}function em(e,t){return(0,g.VC)(e)?t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e:function(e,t){let r;if((0,ei.qG)(e)){var a;let n=(a={name:e.name,parameters:e.schema,description:e.description},(0,A.wF)({type:"function",function:{name:a.name,parameters:ea(a.parameters,{name:a.name}),strict:!0,...a.description?{description:a.description}:void 0}},{callback:a.function,parser:e=>a.parameters.parse(JSON.parse(e))}));r=n.function.parameters?{type:n.type,function:{name:n.function.name,description:n.function.description,parameters:n.function.parameters,...t?.strict!==void 0?{strict:t.strict}:{}}}:{type:"function",function:(0,ei.HU)(e,t)}}else r=e;return t?.strict!==void 0&&(r.function.strict=t.strict),r}(e,t)}function ed(e){return e?.startsWith("o1")||e?.startsWith("o3")}class ef extends f.xV{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??(0,d.getEnvironmentVariable)("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??(0,d.getEnvironmentVariable)("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort,this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,"o1"===this.model&&(this.disableStreaming=!0),this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling)}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return t?.strict!==void 0?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.bind({tools:e.map(e=>em(e,{strict:r})),...t})}createResponseFormat(e){if(e&&"json_schema"===e.type&&e.json_schema.schema&&eg(e.json_schema.schema)){var t,r,a;return t=e.json_schema.schema,r=e.json_schema.name,a={description:e.json_schema.description},(0,A.KT)({type:"json_schema",json_schema:{...a,name:r,strict:!0,schema:ea(t,{name:r})}},e=>t.parse(JSON.parse(e)))}return e}invocationParams(e,t){let r;e?.strict!==void 0?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling);let a={};e?.stream_options!==void 0?a={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(a={stream_options:{include_usage:!0}});let n={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>em(e,{strict:r})):void 0,tool_choice:function(e){if(e)return"any"===e||"required"===e?"required":"auto"===e?"auto":"none"===e?"none":"string"==typeof e?{type:"function",function:{name:e}}:e}(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...a,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(n.prediction=e.prediction);let i=e?.reasoning_effort??this.reasoningEffort;return void 0!==i&&(n.reasoning_effort=i),ed(n.model)?n.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:n.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,n}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){let r=e.tool_calls;if("assistant"===e.role){let n=[],i=[];for(let e of r??[])try{n.push(w(e,{returnId:!0}))}catch(t){var a;i.push((a=t.message,{name:e.function?.name,args:e.function?.arguments,id:e.id,error:a,type:"invalid_tool_call"}))}let s={function_call:e.function_call,tool_calls:r};void 0!==this.__includeRawResponse&&(s.__raw_response=t);let o={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(s.audio=e.audio),new p.Od({content:e.content||"",tool_calls:n,invalid_tool_calls:i,additional_kwargs:s,response_metadata:o,id:t.id})}return new p.cM(e.content||"",e.role??"unknown")}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){let a;let n=e.role??r,i=e.content??"";a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},this.__includeRawResponse&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});let s={usage:{...t.usage}};if("user"===n)return new p.a7({content:i,response_metadata:s});if("assistant"===n){let r=[];if(Array.isArray(e.tool_calls))for(let t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new p.H({content:i,tool_call_chunks:r,additional_kwargs:a,id:t.id,response_metadata:s})}return"system"===n?new p.uU({content:i,response_metadata:s}):"developer"===n?new p.uU({content:i,response_metadata:s,additional_kwargs:{__openai_role__:"developer"}}):"function"===n?new p.FK({content:i,additional_kwargs:a,name:e.name,response_metadata:s}):"tool"===n?new p.dr({content:i,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:s}):new p.XU({content:i,role:n,response_metadata:s})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,r){let a,n;let i=ep(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:i,stream:!0};for await(let e of(await this.completionWithRetry(s,t))){let i=e?.choices?.[0];if(e.usage&&(n=e.usage),!i)continue;let{delta:s}=i;if(!s)continue;let o=this._convertOpenAIDeltaToBaseMessageChunk(s,e,a);a=s.role??a;let l={prompt:t.promptIndex??0,completion:i.index??0};if("string"!=typeof o.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let u={...l};null!=i.finish_reason&&(u.finish_reason=i.finish_reason,u.system_fingerprint=e.system_fingerprint,u.model_name=e.model),this.logprobs&&(u.logprobs=i.logprobs);let c=new m.Cf({message:o,text:o.content,generationInfo:u});yield c,await r?.handleLLMNewToken(c.text??"",l,void 0,void 0,void 0,{chunk:c})}if(n){let e={...n.prompt_tokens_details?.audio_tokens!==null&&{audio:n.prompt_tokens_details?.audio_tokens},...n.prompt_tokens_details?.cached_tokens!==null&&{cache_read:n.prompt_tokens_details?.cached_tokens}},t={...n.completion_tokens_details?.audio_tokens!==null&&{audio:n.completion_tokens_details?.audio_tokens},...n.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:n.completion_tokens_details?.reasoning_tokens}},r=new m.Cf({message:new p.H({content:"",response_metadata:{usage:{...n}},usage_metadata:{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){let a={},n=this.invocationParams(t),i=ep(e,this.model);if(n.stream){let n=this._streamResponseChunks(e,t,r),i={};for await(let e of n){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let t=e.generationInfo?.completion??0;void 0===i[t]?i[t]=e:i[t]=i[t].concat(e)}let s=Object.entries(i).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:l}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,l),c=await this.getNumTokensFromGenerations(s);return a.input_tokens=u,a.output_tokens=c,a.total_tokens=u+c,{generations:s,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...n,stream:!1,messages:i},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...n,stream:!1,messages:i},{signal:t?.signal,...t?.options});let{completion_tokens:r,prompt_tokens:s,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:u}=e?.usage??{};r&&(a.output_tokens=(a.output_tokens??0)+r),s&&(a.input_tokens=(a.input_tokens??0)+s),o&&(a.total_tokens=(a.total_tokens??0)+o),(l?.audio_tokens!==null||l?.cached_tokens!==null)&&(a.input_token_details={...l?.audio_tokens!==null&&{audio:l?.audio_tokens},...l?.cached_tokens!==null&&{cache_read:l?.cached_tokens}}),(u?.audio_tokens!==null||u?.reasoning_tokens!==null)&&(a.output_token_details={...u?.audio_tokens!==null&&{audio:u?.audio_tokens},...u?.reasoning_tokens!==null&&{reasoning:u?.reasoning_tokens}});let c=[];for(let t of e?.choices??[]){let r={text:t.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(t.message??{role:"assistant"},e)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},(0,p.KX)(r.message)&&(r.message.usage_metadata=a),r.message=new p.Od(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),c.push(r)}return{generations:c,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){let e=function(e){let t=["namespace functions {",""];for(let r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(el(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);a+=await this.getNumTokens(e),a+=9}return t&&e.find(e=>"system"===e._getType())&&(a-=4),"none"===r?a+=1:"object"==typeof r&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;"gpt-3.5-turbo-0301"===this.model?(r=4,a=-1):(r=3,a=1);let n=await Promise.all(e.map(async e=>{let n=await this.getNumTokens(e.content),i=await this.getNumTokens(ec(e)),s=void 0!==e.name?a+await this.getNumTokens(e.name):0,o=n+r+i+s;if("function"===e._getType()&&(o-=2),e.additional_kwargs?.function_call&&(o+=3),e?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(t){console.error("Error parsing function arguments",t,JSON.stringify(e.additional_kwargs.function_call)),o+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return t+=o,o}));return{totalCount:t+=3,countPerMessage:n}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw eo(e)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.beta.chat.completions.parse(e,r)}catch(e){throw eo(e)}})}_getClientOptions(e){if(!this.client){let e=function(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:a,azureOpenAIBasePath:n,baseURL:i,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((a||s)&&n&&t)return`${n}/${t}`;if((a||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(a||s){if(!r)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return i}({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new c.z4(t)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let r,a,n,i,s,o;if(void 0!==e&&"object"==typeof e.schema?(r=e.schema,a=e.name,n=e.method,i=e.includeRaw):(r=e,a=t?.name,n=t?.method,i=t?.includeRaw),t?.strict!==void 0&&"jsonMode"===n)throw Error("Argument `strict` is only supported for `method` = 'function_calling'");if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model?"jsonSchema"===n&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`):void 0===n&&(n="jsonSchema"),"jsonMode"===n)s=this.bind({response_format:{type:"json_object"}}),o=eg(r)?y._6.fromZodSchema(r):new y.hU;else if("jsonSchema"===n)s=this.bind({response_format:{type:"json_schema",json_schema:{name:a??"extract",description:r.description,schema:r,strict:t?.strict}}}),o=eg(r)?y._6.fromZodSchema(r):new y.hU;else{let e=a??"extract";if(eg(r)){let a=(0,x.Ik)(r);s=this.bind({tools:[{type:"function",function:{name:e,description:a.description,parameters:a}}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new j({returnSingle:!0,keyName:e,zodSchema:r})}else{let a;"string"==typeof r.name&&"object"==typeof r.parameters&&null!=r.parameters?(a=r,e=r.name):a={name:e=r.title??e,description:r.description??"",parameters:r},s=this.bind({tools:[{type:"function",function:a}],tool_choice:{type:"function",function:{name:e}},...t?.strict!==void 0?{strict:t.strict}:{}}),o=new j({returnSingle:!0,keyName:e})}}if(!i)return s.pipe(o);let l=h.kI.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),u=h.kI.assign({parsed:()=>null}),c=l.withFallbacks({fallbacks:[u]});return h.zZ.from([{raw:s},c])}}function eg(e){return"function"==typeof e?.parse}r(82666),r(10183),r(83722);var eh=r(51118);class ey extends eh.NL{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t={apiKey:e?.apiKey??e?.openAIApiKey??(0,d.getEnvironmentVariable)("OPENAI_API_KEY"),organization:e?.organization??(0,d.getEnvironmentVariable)("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseUrl:e?.baseUrl};this.client=new c.z4(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)):e.flatMap(e=>e.data.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url))}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}let r=await this.client.images.generate(t),a="";return"url"===this.dallEResponseFormat?[a]=r.data.map(e=>e.url).filter(e=>"undefined"!==e):[a]=r.data.map(e=>e.b64_json).filter(e=>"undefined"!==e),a}}Object.defineProperty(ey,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var e_=r(15742),eb=r(94346);async function ev(e){try{let{messages:t,walletAddress:r}=await e.json();console.log("=== API WALLET INFO ==="),console.log("Received wallet address:",r),console.log("Using private key fallback:",!r);let a=!r,n=new u.MoveAgentKit({network:"testnet",...a?{privateKey:process.env.APTOS_PRIVATE_KEY}:{walletAddress:r}});console.log("Agent network:",n.network),console.log("Agent using wallet address:",r||"Using private key instead");let i=t.filter(e=>"user"===e.role).pop()?.content||"",s=`You are a helpful assistant for Aptos blockchain. 
    ${r?`The user's wallet address is: ${r}`:""}
    When asked about wallet information, use this address.`,o=eb.RZ.fromMessages([["system",s],["human","{input}"]]),c=process.env.ANTHROPIC_API_KEY?new e_.Ny({apiKey:process.env.ANTHROPIC_API_KEY}):new ef({apiKey:process.env.OPENAI_API_KEY}),p=o.pipe(c).pipe(new y.oG),m=await p.invoke({input:i});return l.NextResponse.json({content:m})}catch(e){return console.error("Error in chat API:",e),l.NextResponse.json({error:"There was an error processing your request"},{status:500})}}let ek=new i.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"/Users/fujiawang/Desktop/chatbot/app/api/chat/route.ts",nextConfigOutput:"",userland:n}),{workAsyncStorage:ew,workUnitAsyncStorage:eP,serverHooks:eO}=ek;function ej(){return(0,o.patchFetch)({workAsyncStorage:ew,workUnitAsyncStorage:eP})}},32007:()=>{},45919:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[686,180,265],()=>r(41540));module.exports=a})();